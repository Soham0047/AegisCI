name: SecureDev Guardian

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history for diff)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install package + scanners
        run: |
          python -m pip install -U pip
          pip install -e .[dev]
          pip install bandit semgrep

      - name: Fetch base branch
        run: |
          git fetch origin ${{ github.base_ref }} --depth=1

      - name: Run Guardian scan
        run: |
          guardian scan --base-ref ${{ github.base_ref }} --semgrep-config p/ci --out-md report.md --out-json report.json

      - name: Create or update PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const marker = '<!-- SECUREDEV_GUARDIAN -->';

            if (!context.payload.pull_request) {
              core.info('No pull_request context; skipping comment.');
              return;
            }

            if (!fs.existsSync('report.md')) {
              core.setFailed('report.md not found. Ensure the scan step created it.');
              return;
            }

            const rawReport = fs.readFileSync('report.md', 'utf8');
            const lines = rawReport.split(/\r?\n/).filter(line => line.trim() !== marker);
            const body = [marker, ...lines].join('\n');

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.pull_request.number;

            let comments = [];
            try {
              comments = await github.paginate(github.rest.issues.listComments, {
                owner,
                repo,
                issue_number,
                per_page: 100,
              });
            } catch (error) {
              core.warning(`Failed to list PR comments: ${error.message}`);
              return;
            }

            const existing = comments.find(comment => (comment.body || '').includes(marker));

            try {
              if (existing) {
                const updated = await github.rest.issues.updateComment({
                  owner,
                  repo,
                  comment_id: existing.id,
                  body,
                });
                core.info(`Updated comment ${updated.data.id}`);
              } else {
                const created = await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number,
                  body,
                });
                core.info(`Created comment ${created.data.id}`);
              }
            } catch (error) {
              const isFork =
                context.payload.pull_request.head.repo.full_name !==
                context.payload.pull_request.base.repo.full_name;
              const hint = isFork ? ' (likely fork permissions)' : '';
              core.warning(`Failed to create/update comment${hint}: ${error.message}`);
            }
